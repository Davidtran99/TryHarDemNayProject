version: "3.9"
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: hue_portal
      POSTGRES_USER: hue
      POSTGRES_PASSWORD: huepass
    ports:
      - "${POSTGRES_EXPOSE_PORT:-5543}:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
  redis:
    image: redis:7
    ports:
      - "${REDIS_EXPOSE_PORT:-6380}:6379"
  web:
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      DATABASE_URL: postgres://hue:huepass@db:5432/hue_portal
      REDIS_URL: redis://redis:6379/0
      DJANGO_DEBUG: "false"
      DJANGO_SECRET_KEY: "replace-me"
      DJANGO_ALLOWED_HOSTS: "*"
      CORS_ALLOW_ALL_ORIGINS: "true"
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://127.0.0.1:3000"
      LLM_PROVIDER: "ollama"
      OLLAMA_BASE_URL: "http://host.docker.internal:11434"
      OLLAMA_MODEL: "qwen2.5:7b"
    depends_on:
      - db
      - redis
    ports:
      - "8000:8000"
    volumes:
      - ./tài nguyên:/tài nguyên:ro
      - ./backend/hue_portal/artifacts:/app/hue_portal/artifacts
  celery:
    build:
      context: .
      dockerfile: backend/Dockerfile
    command: celery -A hue_portal.hue_portal worker -l info
    environment:
      DATABASE_URL: postgres://hue:huepass@db:5432/hue_portal
      REDIS_URL: redis://redis:6379/0
      DJANGO_DEBUG: "false"
      DJANGO_SECRET_KEY: "replace-me"
      DJANGO_ALLOWED_HOSTS: "*"
      CORS_ALLOW_ALL_ORIGINS: "true"
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://127.0.0.1:3000"
      CELERY_WORKER_CONCURRENCY: "2"
      LLM_PROVIDER: "ollama"
      OLLAMA_BASE_URL: "http://host.docker.internal:11434"
      OLLAMA_MODEL: "qwen2.5:7b"
    volumes:
      - ./backend/hue_portal/artifacts:/app/hue_portal/artifacts
    depends_on:
      - db
      - redis
volumes:
  db_data:

